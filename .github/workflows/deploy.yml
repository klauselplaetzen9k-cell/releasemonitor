name: Deploy

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    if: github.event_name != 'tag' || github.event.inputs.environment != 'production'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configure Docker
        run: |
          mkdir -p ~/.docker
          echo '{"credsStore": "pass"}' > ~/.docker/config.json
          
      - name: Pull images
        run: |
          docker pull ghcr.io/${{ github.repository }}-backend:latest || true
          docker pull ghcr.io/${{ github.repository }}-frontend:latest || true
          
      - name: Deploy with Docker Compose
        run: |
          cp .env.example .env
          sed -i 's|DB_PASSWORD=.*|DB_PASSWORD=${{ secrets.DB_PASSWORD_STAGING }}|g' .env
          sed -i 's|SECRET_KEY=.*|SECRET_KEY=${{ secrets.SECRET_KEY_STAGING }}|g' .env
          docker-compose pull
          docker-compose up -d --build
        working-directory: .
        
      - name: Health Check
        run: |
          sleep 30
          curl -f http://localhost/health || exit 1

  deploy-production:
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configure Docker
        run: |
          mkdir -p ~/.docker
          echo '{"credsStore": "pass"}' > ~/.docker/config.json
          
      - name: Pull latest images
        run: |
          docker pull ghcr.io/${{ github.repository }}-backend:latest || true
          docker pull ghcr.io/${{ github.repository }}-frontend:latest || true
          
      - name: Deploy to Production
        run: |
          cp .env.example .env.production
          sed -i 's|DB_PASSWORD=.*|DB_PASSWORD=${{ secrets.DB_PASSWORD_PROD }}|g' .env.production
          sed -i 's|SECRET_KEY=.*|SECRET_KEY=${{ secrets.SECRET_KEY_PROD }}|g' .env.production
          mv .env.production .env
          docker-compose -f docker-compose.prod.yml pull
          docker-compose -f docker-compose.prod.yml up -d --build
        working-directory: .
        
      - name: Health Check
        run: |
          sleep 60
          curl -f http://localhost/health || exit 1
          
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
